<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <meta name="robots" content="noindex,nofollow"/>
  <title>Učební agent pro syna</title>
  <style>
    :root { --gap: 12px; --card:#fff; --ink:#111; --muted:#666; --bg:#f6f7fb; --ok:#1a7f37; --bad:#c92a2a; }
    *{box-sizing:border-box} body{margin:0;font:16px/1.4 system-ui,-apple-system,Segoe UI;color:var(--ink);background:var(--bg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e9ecef;padding:12px 16px}
    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:var(--gap)}
    .row{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center}
    .card{background:var(--card);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
    button,select,input[type="number"],input[type="text"]{font:inherit;border:1px solid #ced4da;border-radius:12px;padding:10px 12px;background:#fff}
    button{cursor:pointer} button.primary{background:#111;color:#fff;border-color:#111}
    .stat{color:var(--muted)} .ok{color:var(--ok)} .bad{color:var(--bad)} .hidden{display:none}
    @media (hover:hover){button:hover{opacity:.9}}

    /* Chat */
    #chatLog{background:#fff;border-radius:12px;padding:12px;height:260px;overflow:auto;border:1px solid #e9ecef}
    .msg{display:flex;margin:6px 0}
    .msg.me{justify-content:flex-end}
    .msg .bubble{padding:10px 12px;border-radius:14px;max-width:75%;box-shadow:0 1px 4px rgba(0,0,0,.06)}
    .msg.me .bubble{background:#111;color:#fff;border-bottom-right-radius:4px}
    .msg.bot .bubble{background:#f1f3f5;border-bottom-left-radius:4px}
  </style>
</head>
<body>
<header class="row">
  <strong>Učební agent</strong>
  <div style="margin-left:auto" class="row">
    <select id="mode">
      <option value="tables">Násobilka</option>
      <option value="vyjmenovana">Vyjmenovaná slova</option>
      <option value="en">Angličtina (slovíčka)</option>
    </select>
    <button id="reset">Reset statistik</button>
  </div>
</header>

<main>
  <section class="card">
    <div class="row">
      <div>
        <label>Obtížnost: </label>
        <select id="difficulty">
          <option value="easy">Lehká</option>
          <option value="mix" selected>Smíšená</option>
          <option value="hard">Těžká</option>
        </select>
      </div>

      <div id="tablesCfg" class="row">
        <label>Rozsah násobků: </label>
        <input type="number" id="minA" value="1" min="0" max="12" style="width:70px">
        <span>×</span>
        <input type="number" id="maxA" value="10" min="1" max="12" style="width:70px">
      </div>

      <div id="vyjmCfg" class="row hidden">
        <label>Série:</label>
        <select id="series">
          <option value="B">B</option><option value="L">L</option><option value="M">M</option>
          <option value="P">P</option><option value="S">S</option><option value="V">V</option><option value="Z">Z</option>
          <option value="mix" selected>Mix</option>
        </select>
      </div>

      <div id="enCfg" class="row hidden">
        <button id="loadEn" class="primary">Načíst slova z adminu (AI)</button>
        <span class="stat">admin zadává pouze EN slova, AI doplní překlad + větu</span>
      </div>
    </div>
  </section>

  <section class="card" id="quiz">
    <div id="qtext" style="font-size:20px;margin-bottom:8px">Klikni „Další“</div>
    <input id="answer" type="text" placeholder="odpověď" style="width:100%;max-width:420px">
    <div class="row" style="margin-top:12px">
      <button id="check" class="primary">Zkontrolovat</button>
      <button id="next">Další</button>
      <div id="feedback" class="stat"></div>
    </div>
  </section>

  <!-- PROFIL -->
  <section class="card" id="profileCard">
    <strong>Profil agenta (paměť)</strong>
    <div class="row" style="gap:8px;align-items:center">
      <label>Co má rád:</label>
      <input id="likesInput" type="text" placeholder="např. lego, fotbal" style="min-width:260px">
      <label>Denní cíl (otázek):</label>
      <input id="dailyGoalInput" type="number" min="1" value="10" style="width:100px">
      <label>Postava:</label>
      <select id="personaSelect">
        <option value="Robot kamarád">Robot kamarád</option>
        <option value="Vesmírný průzkumník">Vesmírný průzkumník</option>
        <option value="Detektiv">Detektiv</option>
        <option value="Kouzelník">Kouzelník</option>
        <option value="Fotbalový trenér">Fotbalový trenér</option>
      </select>
      <button id="saveProfile" class="primary">Uložit profil</button>
    </div>
    <div class="stat" id="profileMsg"></div>
  </section>

  <!-- CHAT -->
  <section class="card" id="agentCard">
    <div class="row" style="align-items:center;gap:8px">
      <strong>Chat s agentem</strong>
      <span class="stat">• interaktivní trenér</span>
      <span style="flex:1"></span>
      <label>Postava:</label>
      <select id="persona">
        <option value="Robot kamarád" selected>Robot kamarád</option>
        <option value="Vesmírný průzkumník">Vesmírný průzkumník</option>
        <option value="Detektiv">Detektiv</option>
        <option value="Kouzelník">Kouzelník</option>
        <option value="Fotbalový trenér">Fotbalový trenér</option>
      </select>
    </div>

    <div id="chatLog" aria-live="polite"></div>

    <div class="row" style="margin-top:10px">
      <input id="chatInput" type="text" placeholder="Napiš odpověď nebo popros o cvičení (např. ‚zkoušej mě z násobilky 7‘)" style="flex:1">
      <button id="sendChat" class="primary">Poslat</button>
    </div>
    <div class="stat" id="agentHint" style="margin-top:6px">
      Tip: Zkus „dej mi diktát z vyjmenovaných slov S“ nebo „procvič se mnou 10 anglických slov o jídle“.
    </div>
  </section>

  <section class="card">
    <strong>Statistiky</strong>
    <div id="stats" class="stat">—</div>
  </section>
</main>

<script>
/** ---------- Lokální statistiky (zůstanou) ---------- **/
const storeKey = "uceni-agent-v1";
// Trvalé userId (pro profil/pokrok)
const uidKey = "uceni-agent-uid";
let userId = localStorage.getItem(uidKey);
if (!userId) { userId = crypto.randomUUID(); localStorage.setItem(uidKey, userId); }

const state = JSON.parse(localStorage.getItem(storeKey) || '{"hist":[], "deck": [], "streak":0, "seen":0, "ok":0}');
function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
function addHist(item){ state.hist.push({...item, ts: Date.now()}); if(state.hist.length>1000) state.hist.shift(); save(); }
function statRender(){
  const acc = state.seen ? Math.round(100*state.ok/state.seen) : 0;
  document.getElementById('stats').textContent = `Pokusy: ${state.seen} • Úspěšné: ${state.ok} (${acc} %) • Streak: ${state.streak}`;
}
statRender();

/** ---------- Data: Vyjmenovaná (dynamicky z /api/lists) ---------- **/
let VYJM_DATA = null;
async function loadVyjmenovana(){
  try{
    const r = await fetch('/api/lists?type=vyjmenovana'); VYJM_DATA = await r.json();
  }catch(e){
    VYJM_DATA = null;
  }
}
loadVyjmenovana();

/** ---------- Generátory úloh ---------- **/
function rand(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function makeTables(minA,maxA){
  const a = rand(minA, maxA), b = rand(0, 12);
  return { type:"tables", q:`Kolik je ${a} × ${b}?`, correct: String(a*b) };
}

function pickVyjm(series){
  const data = VYJM_DATA || {};
  const keysAvail = Object.keys(data).length ? Object.keys(data) : ["B","L","M","P","S","V","Z"];
  const keys = series==="mix" ? keysAvail : [series];
  const k = keys[rand(0, keys.length-1)];
  const list = (data[k] && data[k].length) ? data[k] : ["b_t"]; // fallback
  const w = list[rand(0, list.length-1)];
  const txt = String(w).replace(/[iyý]/i, "_");
  return { type:"vyjm", q:`Doplň správně i/y: ${txt}`, correct: String(w) };
}

async function loadEnglishFromAdmin(){
  // 1) vezmeme EN slova z /api/lists
  const r = await fetch('/api/lists?type=english_words');
  const data = await r.json();
  const words = Array.isArray(data?.words) ? data.words.slice(0, 20) : ["apple","book","friend"];

  // 2) požádáme AI, aby vytvořila kartičky (en, cz, example, distractors) z těchto slov
  const resp = await fetch("/api/generate",{
    method:"POST", headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ mode:"en-vocab", words })
  });
  const { text } = await resp.json();
  try {
    const arr = JSON.parse(text); // očekává: [{en,cz,example,distractors}]
    state.deck = arr;
  } catch(e){
    state.deck = words.map(w => ({ en:w, cz:"", example:`This is a ${w}.`, distractors:[w+"s","maple"] }));
  }
  save();
}

function makeEnglish(){
  if(!state.deck?.length) return { type:"en", q:"Nejprve načti slova z adminu přes „Načíst slova z adminu (AI)“", correct:"" };
  const it = state.deck[rand(0, state.deck.length-1)];
  const askType = Math.random()<0.5 ? "cz2en" : "en2cz";
  if(askType==="cz2en"){
    return { type:"en", q:`Přelož do EN: „${it.cz || it.en}“`, correct: it.en.toLowerCase(), hint: it.example || "" };
  } else {
    return { type:"en", q:`Co znamená anglicky „${it.en}“?`, correct: (it.cz || "").toLowerCase(), hint: it.example || "" };
  }
}

/** ---------- UI prvky ---------- **/
const modeSel = document.getElementById("mode");
const diffSel = document.getElementById("difficulty");
const qtext = document.getElementById("qtext");
const answer = document.getElementById("answer");
const feedback = document.getElementById("feedback");
const btnCheck = document.getElementById("check");
const btnNext = document.getElementById("next");
const tablesCfg = document.getElementById("tablesCfg");
const vyjmCfg = document.getElementById("vyjmCfg");
const enCfg = document.getElementById("enCfg");
const btnLoadEn = document.getElementById("loadEn");
const btnReset = document.getElementById("reset");

function updateCfg(){
  tablesCfg.classList.toggle("hidden", modeSel.value!=="tables");
  vyjmCfg.classList.toggle("hidden", modeSel.value!=="vyjmenovana");
  enCfg.classList.toggle("hidden", modeSel.value!=="en");
}
updateCfg();
modeSel.addEventListener("change", updateCfg);

async function nextQ(){
  feedback.textContent = "";
  answer.value = "";
  if(modeSel.value==="tables"){
    const minA = +document.getElementById("minA").value || 1;
    const maxA = +document.getElementById("maxA").value || 10;
    qtext.textContent = (current = makeTables(minA, maxA)).q;
  } else if(modeSel.value==="vyjmenovana"){
    const series = document.getElementById("series").value;
    qtext.textContent = (current = pickVyjm(series)).q;
  } else {
    current = makeEnglish();
    qtext.textContent = current.q;
  }
  answer.focus();
}
btnNext.addEventListener("click", nextQ);

/** ---------- Kontrola odpovědi + zápis na server ---------- **/
let current = null;
btnCheck.addEventListener("click", ()=>{
  if(!current) return;
  const a = (answer.value || "").trim().toLowerCase();
  const ok = a && current.correct && a === current.correct.toLowerCase();

  state.seen++;
  if (ok) { state.ok++; state.streak++; feedback.innerHTML = `<span class="ok">Správně!</span>`; }
  else { state.streak = 0; feedback.innerHTML = `<span class="bad">Ještě ne. Správně: ${current.correct}</span>`; }

  addHist({ mode: modeSel.value, q: current.q, a, correct: current.correct, ok });

  // serverové statistiky (Postgres)
  fetch("/api/progress", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId, mode: modeSel.value, correct: ok, item: current.q })
  }).catch(()=>{});

  statRender();
});

btnLoadEn.addEventListener("click", async ()=>{
  btnLoadEn.disabled = true; btnLoadEn.textContent = "Načítám…";
  await loadEnglishFromAdmin();
  btnLoadEn.disabled = false; btnLoadEn.textContent = "Načíst slova z adminu (AI)";
  alert("Balíček načten. Můžeš cvičit.");
});

btnReset.addEventListener("click", ()=>{
  if(confirm("Smazat statistiky v zařízení?")){ localStorage.removeItem(storeKey); location.reload(); }
});

/** ---------- Chat s agentem ---------- **/
const chatLogEl = document.getElementById('chatLog');
const chatInputEl = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');
const personaSel = document.getElementById('persona');

let chatHistory = [];
function esc(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c] )); }
function addMsg(role, content){
  chatHistory.push({ role, content });
  const html = `<div class="msg ${role==='user'?'me':'bot'}"><div class="bubble">${esc(content)}</div></div>`;
  chatLogEl.insertAdjacentHTML('beforeend', html);
  chatLogEl.scrollTop = chatLogEl.scrollHeight;
}
async function sendChat(){
  const text = (chatInputEl.value || "").trim();
  if(!text) return;
  addMsg('user', text);
  chatInputEl.value = ''; chatInputEl.focus(); sendChatBtn.disabled = true;
  try{
    const r = await fetch('/api/agent', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ persona: personaSel.value, message: text, history: chatHistory, userId })
    });
    const data = await r.json();
    let reply = data?.reply || 'Promiň, něco se nepovedlo. Zkus to ještě jednou.';
    let meta = null;

    // Podpora skryté meta informace: [[META]] { ...json... }
    const parts = reply.split('[[META]]');
    if (parts.length > 1) {
      reply = parts[0].trim();
      try { meta = JSON.parse(parts[1]); } catch {}
    }

    addMsg('assistant', reply);

    // pokud agent vyhodnotil odpověď, zapiš pokrok
    if (meta && meta.event === 'evaluate') {
      const mode = meta.mode || 'unknown';
      const item = meta.item || null;
      const correct = !!meta.correct;
      fetch('/api/progress', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, mode, correct, item })
      }).catch(()=>{});
    }
  }catch(e){
    addMsg('assistant', 'Ups, spojení selhalo. Zkus to znovu.');
  }finally{
    sendChatBtn.disabled = false;
  }
}
sendChatBtn.addEventListener('click', sendChat);
chatInputEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') sendChat(); });
personaSel.addEventListener('change', ()=>{
  chatHistory = [];
  chatLogEl.innerHTML = '';
  addMsg('assistant', `Ahoj! Jsem ${personaSel.value}. Řekni mi, co chceš dnes trénovat – násobilku, vyjmenovaná slova, nebo angličtinu.`);
});
// úvodní pozdrav
addMsg('assistant', 'Ahoj! Jsem Robot kamarád. Umím tě zkoušet z násobilky, vyjmenovaných slov a angličtiny. Co dáme jako první?');

/** ---------- Profil (Postgres) ---------- **/
const likesInput = document.getElementById('likesInput');
const dailyGoalInput = document.getElementById('dailyGoalInput');
const personaSelectProfile = document.getElementById('personaSelect');
const saveProfileBtn = document.getElementById('saveProfile');
const profileMsg = document.getElementById('profileMsg');
const personaSelChat = personaSel;

function setPersonaUI(val){
  if (personaSelectProfile) personaSelectProfile.value = val;
  if (personaSelChat) personaSelChat.value = val;
}
async function loadProfile(){
  try{
    const r = await fetch(`/api/profile?userId=${encodeURIComponent(userId)}`);
    const p = await r.json();
    likesInput.value = (p.likes || []).join(', ');
    dailyGoalInput.value = p?.goals?.dailyQuestions ?? 10;
    setPersonaUI(p.persona || 'Robot kamarád');
    profileMsg.textContent = 'Profil načten.';
  }catch(e){
    profileMsg.textContent = 'Profil se nepodařilo načíst.';
  }
}
async function saveProfile(){
  const likes = likesInput.value.split(',').map(s=>s.trim()).filter(Boolean);
  const daily = Math.max(1, parseInt(dailyGoalInput.value || '10', 10));
  const persona = (personaSelectProfile?.value) || 'Robot kamarád';
  try{
    const r = await fetch('/api/profile', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ userId, patch: { likes, persona, goals: { dailyQuestions: daily } } })
    });
    const p = await r.json();
    setPersonaUI(p.persona || 'Robot kamarád');
    profileMsg.textContent = 'Uloženo.';
  }catch(e){
    profileMsg.textContent = 'Uložení se nepodařilo.';
  }
}
if (saveProfileBtn) saveProfileBtn.addEventListener('click', saveProfile);
loadProfile();
</script>
</body>
</html>
